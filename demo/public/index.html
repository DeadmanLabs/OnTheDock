<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnTheDock - Docker Management Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #0db7ed;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="text-4xl mr-4">üê≥</div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">OnTheDock</h1>
                        <p class="text-gray-600">Docker Management Library Demo</p>
                    </div>
                </div>
                <button onclick="refreshAll()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <!-- System Info -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8" id="systemInfo">
            <h2 class="text-2xl font-bold mb-4">System Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="systemStats">
                <div class="text-center">
                    <div class="spinner mx-auto"></div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex">
                    <button onclick="showTab('containers')" id="containersTab" class="py-2 px-6 border-b-2 border-blue-500 font-medium text-blue-600">
                        Containers
                    </button>
                    <button onclick="showTab('images')" id="imagesTab" class="py-2 px-6 border-b-2 border-transparent font-medium text-gray-600 hover:text-gray-800">
                        Images
                    </button>
                    <button onclick="showTab('logs')" id="logsTab" class="py-2 px-6 border-b-2 border-transparent font-medium text-gray-600 hover:text-gray-800">
                        Logs
                    </button>
                </nav>
            </div>

            <!-- Containers Tab -->
            <div id="containersContent" class="p-6">
                <h2 class="text-2xl font-bold mb-4">Containers</h2>
                <div id="containersList">
                    <div class="text-center">
                        <div class="spinner mx-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Images Tab -->
            <div id="imagesContent" class="p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Images</h2>
                <div id="imagesList">
                    <div class="text-center">
                        <div class="spinner mx-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logsContent" class="p-6 hidden">
                <h2 class="text-2xl font-bold mb-4">Container Logs</h2>
                <select id="logContainerSelect" class="mb-4 p-2 border rounded" onchange="loadLogs()">
                    <option value="">Select a container...</option>
                </select>
                <div id="logsOutput" class="bg-gray-900 text-green-400 p-4 rounded h-96 overflow-y-auto font-mono text-sm">
                    Select a container to view logs
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3001/api';
        let currentTab = 'containers';
        let allContainers = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            refreshAll();
            setInterval(refreshCurrent, 5000);
        });

        async function refreshAll() {
            await loadSystemInfo();
            await loadContainers();
            await loadImages();
        }

        function refreshCurrent() {
            if (currentTab === 'containers') loadContainers();
            else if (currentTab === 'images') loadImages();
            loadSystemInfo();
        }

        function showTab(tab) {
            currentTab = tab;
            
            // Update tab styles
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            document.getElementById(tab + 'Tab').classList.remove('border-transparent', 'text-gray-600');
            document.getElementById(tab + 'Tab').classList.add('border-blue-500', 'text-blue-600');
            
            // Show/hide content
            document.querySelectorAll('[id$="Content"]').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tab + 'Content').classList.remove('hidden');
        }

        async function loadSystemInfo() {
            try {
                const response = await axios.get(`${API_URL}/info`);
                const info = response.data;
                
                document.getElementById('systemStats').innerHTML = `
                    <div class="bg-blue-50 p-4 rounded">
                        <div class="text-3xl font-bold text-blue-600">${info.containers}</div>
                        <div class="text-gray-600">Total Containers</div>
                        <div class="text-sm text-gray-500">${info.containersRunning} running</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded">
                        <div class="text-3xl font-bold text-green-600">${info.images}</div>
                        <div class="text-gray-600">Images</div>
                        <div class="text-sm text-gray-500">Available locally</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded">
                        <div class="text-3xl font-bold text-purple-600">${info.cpus}</div>
                        <div class="text-gray-600">CPUs</div>
                        <div class="text-sm text-gray-500">${formatBytes(info.memTotal)} RAM</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded col-span-3">
                        <div class="text-sm">
                            <strong>Docker Version:</strong> ${info.serverVersion} | 
                            <strong>OS:</strong> ${info.os} | 
                            <strong>Kernel:</strong> ${info.kernelVersion}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }

        async function loadContainers() {
            try {
                const response = await axios.get(`${API_URL}/containers`);
                allContainers = response.data;
                
                // Update container select for logs
                const select = document.getElementById('logContainerSelect');
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select a container...</option>';
                allContainers.forEach(container => {
                    const option = document.createElement('option');
                    option.value = container.id;
                    option.textContent = `${container.name} (${container.state})`;
                    select.appendChild(option);
                });
                select.value = currentValue;
                
                // Display containers
                if (allContainers.length === 0) {
                    document.getElementById('containersList').innerHTML = '<p class="text-gray-500">No containers found</p>';
                    return;
                }
                
                document.getElementById('containersList').innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2 text-left">Status</th>
                                    <th class="px-4 py-2 text-left">Name</th>
                                    <th class="px-4 py-2 text-left">Image</th>
                                    <th class="px-4 py-2 text-left">Created</th>
                                    <th class="px-4 py-2 text-left">Ports</th>
                                    <th class="px-4 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allContainers.map(container => `
                                    <tr class="border-t">
                                        <td class="px-4 py-2">
                                            <span class="inline-block w-3 h-3 rounded-full ${getStatusColor(container.state)}"></span>
                                            <span class="ml-2 text-sm">${container.state}</span>
                                        </td>
                                        <td class="px-4 py-2 font-medium">${container.name}</td>
                                        <td class="px-4 py-2 text-sm">${container.image}</td>
                                        <td class="px-4 py-2 text-sm">${new Date(container.created * 1000).toLocaleDateString()}</td>
                                        <td class="px-4 py-2 text-sm">
                                            ${container.ports.map(p => 
                                                p.PublicPort ? `${p.PublicPort}:${p.PrivatePort}` : p.PrivatePort
                                            ).join(', ') || '-'}
                                        </td>
                                        <td class="px-4 py-2">
                                            ${getContainerActions(container)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load containers:', error);
                document.getElementById('containersList').innerHTML = '<p class="text-red-500">Failed to load containers</p>';
            }
        }

        async function loadImages() {
            try {
                const response = await axios.get(`${API_URL}/images`);
                const images = response.data;
                
                if (images.length === 0) {
                    document.getElementById('imagesList').innerHTML = '<p class="text-gray-500">No images found</p>';
                    return;
                }
                
                document.getElementById('imagesList').innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-2 text-left">Repository</th>
                                    <th class="px-4 py-2 text-left">Tag</th>
                                    <th class="px-4 py-2 text-left">Image ID</th>
                                    <th class="px-4 py-2 text-left">Created</th>
                                    <th class="px-4 py-2 text-left">Size</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${images.map(image => {
                                    const tags = image.tags.filter(t => t !== '<none>:<none>');
                                    if (tags.length === 0) tags.push('<none>');
                                    
                                    return tags.map(tag => {
                                        const [repo, version] = tag.includes(':') ? tag.split(':') : [tag, '<none>'];
                                        return `
                                            <tr class="border-t">
                                                <td class="px-4 py-2 font-medium">${repo}</td>
                                                <td class="px-4 py-2">
                                                    <span class="px-2 py-1 bg-gray-100 rounded text-sm">${version}</span>
                                                </td>
                                                <td class="px-4 py-2 text-sm font-mono">${image.id.substring(7, 19)}</td>
                                                <td class="px-4 py-2 text-sm">${new Date(image.created * 1000).toLocaleDateString()}</td>
                                                <td class="px-4 py-2 text-sm">${formatBytes(image.size)}</td>
                                            </tr>
                                        `;
                                    }).join('');
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load images:', error);
                document.getElementById('imagesList').innerHTML = '<p class="text-red-500">Failed to load images</p>';
            }
        }

        async function loadLogs() {
            const containerId = document.getElementById('logContainerSelect').value;
            if (!containerId) {
                document.getElementById('logsOutput').innerHTML = 'Select a container to view logs';
                return;
            }
            
            try {
                const response = await axios.get(`${API_URL}/containers/${containerId}/logs`);
                document.getElementById('logsOutput').innerHTML = `<pre>${escapeHtml(response.data)}</pre>`;
                document.getElementById('logsOutput').scrollTop = document.getElementById('logsOutput').scrollHeight;
            } catch (error) {
                document.getElementById('logsOutput').innerHTML = `<span class="text-red-400">Failed to load logs: ${error.message}</span>`;
            }
        }

        function getStatusColor(state) {
            switch(state) {
                case 'running': return 'bg-green-500';
                case 'paused': return 'bg-yellow-500';
                case 'exited': return 'bg-gray-500';
                case 'dead': return 'bg-red-500';
                default: return 'bg-gray-400';
            }
        }

        function getContainerActions(container) {
            const actions = [];
            
            if (container.state === 'running') {
                actions.push(`<button onclick="stopContainer('${container.id}')" class="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">Stop</button>`);
                actions.push(`<button onclick="restartContainer('${container.id}')" class="px-2 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">Restart</button>`);
            } else {
                actions.push(`<button onclick="startContainer('${container.id}')" class="px-2 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">Start</button>`);
            }
            
            actions.push(`<button onclick="removeContainer('${container.id}')" class="px-2 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">Remove</button>`);
            
            return actions.join(' ');
        }

        async function startContainer(id) {
            try {
                await axios.post(`${API_URL}/containers/${id}/start`);
                await loadContainers();
            } catch (error) {
                alert('Failed to start container: ' + error.message);
            }
        }

        async function stopContainer(id) {
            try {
                await axios.post(`${API_URL}/containers/${id}/stop`);
                await loadContainers();
            } catch (error) {
                alert('Failed to stop container: ' + error.message);
            }
        }

        async function restartContainer(id) {
            try {
                await axios.post(`${API_URL}/containers/${id}/restart`);
                await loadContainers();
            } catch (error) {
                alert('Failed to restart container: ' + error.message);
            }
        }

        async function removeContainer(id) {
            if (!confirm('Are you sure you want to remove this container?')) return;
            
            try {
                await axios.delete(`${API_URL}/containers/${id}`);
                await loadContainers();
            } catch (error) {
                alert('Failed to remove container: ' + error.message);
            }
        }

        function formatBytes(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>